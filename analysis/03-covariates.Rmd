---
title: "COVARIATES"
author: "Andree Valle Campos"
date: '`r Sys.Date()`'
output: 
  html_document:
#  pdf_document:
#  html_notebook:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
    code_folding: "hide"
#    number_sections: TRUE
#    df_print: kable
#    fig_caption: true
#  documentclass: report
bibliography: SeroMarker.bib
csl: american-medical-association.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, # CHANGE TO FALSE IN PDF_DOCUMENTS
                      warning = FALSE) 
knitr::opts_knit$set(root.dir = '../.') #gsub("/analysis","",getwd())
#getwd()
options(width = 110) # CHANGE TO DEFAULT in PDF
# FOR PDF CHANGE: html_document, toc_float, number_sections, echo, width
# FOR PDF add new page USE: four \newpage BEFORE #SETUP #APPENDIX #COMPUTER.env #REFERENCES
```

# Setup 

This report is writen in **R** [@R] within a `Rmarkdown` [@rmarkdown] notebook using the `RStudio` [@rstudio] IDE software, and employing the `knitr` [@knitr] and `Hmisc` [@Hmisc] packages for the `html` setup.

This dynamic document integrates **text**, **code** and **results**.

```{r setup0, results='hide', message=FALSE, eval=TRUE}
require(Hmisc)
#require(plotly)
#options(#grType='plotly',  # for certain graphics functions
#        width = 110) # to expand the limits of CONSOLE output
mu <- markupSpecs$html   # markupSpecs is in Hmisc

# The following hidden command (<code>r mu$widescreen()</code>), causes the html notebook to use an entire wide screen.
#mu$widescreen()
```
`r mu$widescreen()`

# Summary

**OBJECTIVE:**

* Principal: 
    - Standardize the OD~450nm~ values across ELISA plates by the estimation of the Antibody Units of each unknown sample.

* Secondary:
    - Implement a [reproducible workflow](https://www.ncbi.nlm.nih.gov/pubmed/26776185) for standardization of ELISA plates from a template matrix.


# Introduction

This is an R implementation of a pipeline for the standardization of ELISA plates directly from a template matrix.


# Dependencies

The required R packages for this analysis are:

+ XLConnect [@XLConnect]
+ drc [@Ritz2015]

```{r, results='hide', message=FALSE}
##essential
library(XLConnect)    # load EXCEL workbooks
library(drc)          # Dose-Response modeling
##accesory
library("DiagrammeR") # method Flowchart
library("knitr")      # To display nice tables
library("tidyverse")
#ggplot2, tibble, tidyr, readr, purr, dplyyr
##extra
library("Rmisc")      # multiplot ggplots
library("haven")      # import STATA df
library("readxl")     # import EXCEL df
library("forcats")    # factor vectors
library("viridis")    # color visualization
```

# read .Rds
```{r}
std.nty <- readRDS("data/02-standard-tidy.rds")
std.uty <- readRDS("data/02-standard-untidy.rds")
```

- total amount of observations **`r length(std.nty$ID)`** in `std.nty`.
- total amount of evaluated patients **`r length(levels(std.nty$ID))`** in `std.nty`.
- giving **`r length(std.uty$ID)`** available samples in `std.uty`.

# Covariates

The original non-standardized names of the **06** datasets with covariates are:

```{bash}
ls data-raw/ | grep -v "Template" | grep -v "zip" | grep -v "do"
```

In order to follow standardize names, the files we copied and renamed:

```{bash}
cp data-raw/UNAPdatabase20Sept16-pre.dta \
data/UNAP-1-DB-20sep2016.dta

cp data-raw/Zungarococha_database1_3Oct2016.csv \
data/UNAP-2-DB-03oct2016.csv

cp data-raw/UNAPdatabase20Sept16.dta \
data/UNAP-3-DB-02nov2016.dta

cp data-raw/RESULTADOS_LABORATORIO_PRIMER\ BARRIDO\ \(JUL-\ AGO\ 2015\).xlsx \
data/UNAP-4-UP-16ene2017.xlsx

cp data-raw/QC\ results\ Zungarococha.xlsx \
data/UNAP-5-QC-08feb2017.xlsx

cp data-raw/Base\ datos\ epidemiologicos\ 2015.xlsx \
data/UNAP-6-EPI-08feb2017.xlsx
```

New names include:

- order of appearance throughout the project
- relevand info: DB, UP, QC or EPI
- date of registered last edition, or
- receipt date

```{bash}
ls -sh data/UNAP-*
```

# AIM

- check if `unap1` is equal to `unap2`
- `unap3` should be equal to `unap2` plus seropositivity agregate columns
- `unap3` was used in the online meeting with Nuno
- `unap4` have updated covariates and differs from `unap3`
- `unap5` have QC evaluations
- contrast:
    + `unap3` as prev-DB
    + `unap4` as post-DB
    + `unap5` as data-QC
- `unap6` will be edited in another .Rmd
- contrast:
    + `unap6` as prev-EPI


# RESULTS

- `unap6` is the **source** for `unap1` age and sex covariates only.
- `unap1` is the **source** of all other `unap#` DB
- `unap2` is a **subset** of `unap1` shared with Nuno
- `unap3` is `unap1` plus **05** more seropositivity covariates
- `unap4` is `unap1` but with **updated** age and sex covariates
- `unap5` is `unap1` plus **QC** evaluations of micro and pcr covariates
- `unap5` is **different** from `unap1` only in micro UNAP covariate
- `unap1` UNAP covariates were arbitrarily **selected** to compare against `unap5` NAMR ones.
- `unap0` was created as a **merged** DB of covariates
- `unap0` was **merged** with `std.uty` DB of mean.OD and Ab.units per specie obtained in **02-data-filtering.Rmd**
- `std.uty.cov` was **written** in a `.csv` and **saved** in a `.rds` for further analysis.

- diagram of DB history

```{r, fig.align='center', fig.width=9, fig.height=3}
#install.packages("DiagrammeR")
#library(DiagrammeR)

grViz("
digraph unap_summary {

graph [layout= dot,
        rankdir= LR]

# node definitions with substituted label text
node [fontname = Helvetica]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4', color= red, fontcolor= red]
e [label = '@@5', color= red, fontcolor= red]
f [label = '@@6', color= green, fontcolor= green]
g [label = '@@7', color= blue, fontcolor= blue]

# edge definitions with the node IDs
a -> {b c}
a -> {d e}  [color= red]
f -> a [color= green]
{a d e} -> g [color= blue]
}

[1]: 'unap1 DB (27)'
[2]: 'unap2 DB (8)'
[3]: 'unap3 DB (32)'
[4]: 'unap4 UP (8)'
[5]: 'unap5 QC (4)'
[6]: 'unap6 EPI (109)'
[7]: 'unap0 DB (14)'
")
```

# PROCEDURE

## UNAP-1-DB-20sep2016.dta

discoveries:

- `unap1` already have part of the seropositivity output (also present in `unap3`)
- variables absent in `unap2` are listed
- removed columns:
    + micro2 and dens2
    + OD reads
    + sero-positive results (cutoff + categories)
    + age categories
    + pcrsnou 1/2 and pcrrubio 1/2

```{r}
unap1 <- haven::read_dta("data/UNAP-1-DB-20sep2016.dta") %>%
  haven::as_factor()
# previous removing
unap1.out <- unap1 %>% select((micro2:age3), -pcrrubio)
unap1 <- unap1 %>% select(-(micro2:age3), pcrrubio)
#unap1$id <- forcats::as_factor(unap1$id) # not required
str(unap1)
summary(unap1)
```

```{r}
colnames(unap1.out)
```


## UNAP-2-DB-03oct2016.csv

discoveries:

- `unap2` is a **subset** of `unap1`
- `unap2` do not used **pvmsp1n** variable
- removed columns:
    + OD reads


```{r}
unap2 <- readr::read_csv("data/UNAP-2-DB-03oct2016.csv") %>%
  dplyr::mutate_each(funs(factor), 2, 4, 5, 9)
#str(unap2)
unap2.out <- unap2 %>% select(matches(".msp.")) # previous removing
unap2 <- unap2 %>% select(-matches(".msp.")) # OD reads removing
str(unap2)
summary(unap2)
```
```{r}
colnames(unap2.out)
```



## UNAP-3-DB-02nov2016.dta

discoveries:

- `unap3` is identical to `unap1` plus **05 more columns** about seropositivity
- removed columns:
    + micro2 and dens2
    + OD reads
    + sero-positive results (cutoff + categories + 5 columns)
    + age categories
    + pcrsnou 1/2 and pcrrubio 1/2

```{r}
unap3 <- haven::read_dta("data/UNAP-3-DB-02nov2016.dta") %>% 
  haven::as_factor()
#str(unap3)
# previous removing
unap3.out <- unap3 %>% select((micro2:ll_pvmsp1pos), -pcrrubio)
unap3 <- unap3 %>% select(-(micro2:ll_pvmsp1pos), pcrrubio)
#unap3$id <- forcats::as_factor(unap3$id) # not required
str(unap3)
summary(unap3)
```

```{r}
colnames(unap3.out)
#summary(select(unap3.out, (seroposall:ll_pvmsp1pos)))
```


## UNAP-4-UP-16ene2017.xlsx

discoveries:

- `unap4` is identical to `unap1` with **updated** `age` and `sex` covariates
- `unap1` is the original source of all `unap#` covariates
    + then, all covariates should be retrieved from `unap1`

```{r}
#read xl
unap4 <- readxl::read_excel("data/UNAP-4-UP-16ene2017.xlsx", 
                            sheet = 1, na = ".") %>%
  dplyr::select(id=1, sex=3, age=2, community=4, micro1=5, dens1=6, 
                pcrrubio_Pv=12, pcrrubio_Pf=13, pcrsnounou_Pv=14, pcrsnounou_Pf=15) %>%
  dplyr::mutate(pcrrubio= pcrrubio_Pf + pcrrubio_Pv,
                pcrsnounou= pcrsnounou_Pf + pcrsnounou_Pv) %>%
  dplyr::select(id:dens1,pcrrubio, pcrsnounou) %>%
  dplyr::mutate_each(funs(factor), 2,4,5,7,8)
str(unap4)
summary(unap4)
```

### unap4 covariate labels

Covariate labeling is based on labels available in covariate DB sheet 2. If more clarity is required, we only need to change those cells.

```{r}
unap4.xl <- XLConnect::loadWorkbook("data/UNAP-4-UP-16ene2017.xlsx")
#
unap4.lb <- readWorksheet(unap4.xl, header = F,
                      sheet = 2, 
                      startRow = 8, endRow = 16,
                      startCol = 2, endCol = 6)
unap4.lb
```


## UNAP-5-QC-08feb2017.xlsx

discoveries:

- `unap1` **micro1** is different from `unap5` **micro.unap**
- **why?**

```{r}
#read xl
unap5 <- readxl::read_excel("data/UNAP-5-QC-08feb2017.xlsx", na = "-")
#colnames(unap5)
unap5 <- unap5[,1:5]
#
unap5 <- unap5 %>% 
  dplyr::select(id=1, pcr.unap=4, pcr.namr=5,  
                micro.unap=2, micro.namr=3) %>%
  dplyr::mutate(micro.comp= micro.unap==micro.namr,
                pcr.comp= pcr.unap==pcr.namr) %>%
  dplyr::select(1:3,7,4:5,6) #%>%
  #dplyr::mutate_each(funs(factor), 2,3,5,6)
str(unap5)
summary(unap5 %>%
          select(1,4,7))
```

### test equality

- `unap1` and `unap5` should have equal **micro** and **pcr** ***UNAP*** covariates
- suffix:
    + `_1`: `unap1`
    + `_5`: `unap5` **UNAP** covariates
    + `_0`: comparison between `_1` and `_5`
    + `_n`: `unap5` **NAMR** covariates
    + `_n1`: `_n` vs `_1`
    + `_n5`: `_n` vs `_5`

```{r}
unap5c <- unap5 %>%
  select(id, micro_5= micro.unap, pcr_5=pcr.unap) %>%
  join(unap1 %>% #full_join(unap1 %>%
              select(id, micro_1= micro1, pcr_1=pcrrubio), 
            by= "id") %>%
  mutate(micro_1= fct_recode(micro_1,
                             "0"= "Negative", 
                             "1"= "P vivax", 
                             "2"= "P falciparum", 
                             "3"= "Pv/Pf mixed infection"),
         pcr_1= fct_recode(pcr_1, 
                           "0"= "Negative", 
                           "1"= "P vivax", 
                           "2"= "P falciparum",
                           "3"= "Pv/Pf mixed infection")) %>%
  mutate(micro_0= micro_1==micro_5, 
         pcr_0= pcr_1==pcr_5) %>%
  full_join(unap5 %>%
              select(id, micro_n= micro.namr, pcr_n= pcr.namr), 
            by="id") %>%
  mutate(micro_n1= micro_n==micro_1,
         micro_n5= micro_n==micro_5,
         pcr_n1= pcr_n==pcr_1,
         pcr_n5= pcr_n==pcr_5) %>%
  select(1,4,2,6,8,10,11,5,3,7,9,12,13) %>%
  dplyr::mutate_each(funs(factor), 3,5,9,11)
  
str(unap5c)
```

**pcr_1** and **pcr_5** are equivalent:

```{r}
summary(unap5c %>% 
          select(8:13))
```

However, **micro_1** and **micro_5** are different in **43** cells

```{r}
summary(unap5c %>% 
          select(2:7))
```

### selection

Arbitrary selection of `unap1` as **UNAP** covariates to compare against `unap5` **NAMRU** ones.

```{r}
unap5d <- unap5c %>%
  select(1, 
         2,5,6, 
         8,11,12)
summary(unap5d)
```


## UNAP-6-EPI-08feb2017.xlsx

- New question, New .Rmd

```{r}
#read xl
unap6 <- readxl::read_excel("data/UNAP-6-EPI-08feb2017.xlsx", sheet = 1)
#filter NA
unap6 <- unap6[1:sum(unap6$id_integrante != "", na.rm = T), 
           1:sum(colnames(unap6) != "", na.rm= T)]
#963x109
#colnames(unap6)
#str(unap6)
```

# MERGE COVARIATES

TO DO:

- `unap0` is in a **untidy** format!!
- `unap0` requires to be tidy **before** merging it with `std.nty`

AIM:

- create `unap0`
- merge 
    + `unap1` age, sex
    + `unap4` age, sex
    + change factor label in sex
    + create 2 logic variables
    + `unap5` all (micro, pcr)
    + `unap1` community
    + avoided: dens1, micro2, dens2, pcr.snounou
- suffix:
    + `_1`: `unap1`
    + `_4`: `unap4`
    + `_0`: comparison between `_1` and `_4`
    + `_n`: `unap5` **NAMR** covariates
    + `_n1`: `_n` vs `_1`


```{r}
#str(unap1)
#str(unap4)
unap4$sex <- fct_recode(unap4$sex, Female="1", Male="2")
#str(unap4)

unap0 <- 
  full_join(
    unap1 %>%
      select(id, age, sex), 
    unap4 %>%
      select(id, age, sex), 
    by= "id", suffix= c("_1", "_4")) %>%
  mutate(sex_0= sex_1==sex_4,
         age_0= age_1==age_4)%>%
  select(1,3,5,6,2,4,7)%>%
  full_join(unap5d, by= "id") %>%
  full_join(unap1 %>%
              select(id,community_1= community#, 
                     #micro_1= micro1, dens_1= dens1, pcr_1=pcrrubio
                     ),
            by="id")
#
#unap0
str(unap0)
#summary(unap0)

```

# MERGE AB UNTIS

## tidy format

- not yet!

```{r, eval=FALSE}
std.nty.cov <- std.nty %>%
  select(id=ID, 2:5) %>%
  full_join(unap0, by="id") #%>%
#select(1:14,21,15:17,19,20,18)
str(std.nty.cov)
summary(std.nty.cov)
#View(std.nty.cov)
readr::write_csv(std.nty.cov %>%
            format(scientific=FALSE, digits=2), "data/03-standard-tidy-cov.csv")
saveRDS(std.nty.cov, "data/03-standard-tidy-cov.rds")
```


## untidy format

```{r}
std.uty.cov <- std.uty %>%
  select(id=ID, 2:5) %>%
  full_join(unap0, by="id") #%>%
  #select(1:14,21,15:17,19,20,18)
str(std.uty.cov)
summary(std.uty.cov)
#View(std.uty.cov)
readr::write_csv(std.uty.cov %>%
            format(scientific=FALSE, digits=2), "data/03-standard-untidy-cov.csv")
saveRDS(std.uty.cov, "data/03-standard-untidy-cov.rds")
```

# EXPORT

- `std.uty.cov` output was written as `data/03-standard-untidy-cov.csv`.
- `std.nty.cov` output was written as `data/03-standard-tidy-cov.csv`:

***

# previous report

## EVALUATE 01 patient 02 IDs

- AIM:
    + Contrast the data of the samples mentioned in the 2nd sheet of `UNAP-4-UP-16ene2017.xlsx`

```{r}
#unap4.xl <- XLConnect::loadWorkbook("data/UNAP-4-UP-16ene2017.xlsx")
unap4.dl <- readWorksheet(unap4.xl, 
                      sheet = 2, 
                      startRow = 20, endRow = 27,
                      startCol = 2, endCol = 3)
unap4.dl

#str(unap4.dl)
```

Strings were split into individual characters in the following way:
```{r}
strsplit(unap4.dl[5,], split = " ")[[1]]
```

Check equality between pair of samples:
```{r, eval=FALSE}
unap4.dlMIX <- data.frame()
for(i in 1:dim(unap4.dl)[1]) {
  unap4.dlMIX <- rbind(unap4.dlMIX,
                      std.uty.cov[std.uty.cov$id==
                                   strsplit(unap4.dl[i,], 
                                            split = " ")[[1]][1],],
                      std.uty.cov[std.uty.cov$id==
                                   strsplit(unap4.dl[i,], 
                                            split = " ")[[1]][3],])
}
unap4.dlMIX
#format(unap4.dlMIX[,-c(7,8,10)], scientific=FALSE, digits=2)#
```

Some equalities do not seem to be from the same patient. This step needs more support prior to any sample deletion.



# References