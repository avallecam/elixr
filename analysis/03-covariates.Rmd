---
title: "COVARIATES"
author: "Andree Valle Campos"
date: '`r Sys.Date()`'
output: 
  html_document:
#  pdf_document:
#  html_notebook:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
    code_folding: "hide"
#    number_sections: TRUE
#    df_print: kable
#    fig_caption: true
#  documentclass: report
bibliography: SeroMarker.bib
csl: american-medical-association.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, # CHANGE TO FALSE IN PDF_DOCUMENTS
                      warning = FALSE) 
knitr::opts_knit$set(root.dir = '../.') #gsub("/analysis","",getwd())
#getwd()
options(width = 110) # CHANGE TO DEFAULT in PDF
# FOR PDF CHANGE: html_document, toc_float, number_sections, echo, width
# FOR PDF add new page USE: four \newpage BEFORE #SETUP #APPENDIX #COMPUTER.env #REFERENCES
```

# Setup 

This report is writen in **R** [@R] within a `Rmarkdown` [@rmarkdown] notebook using the `RStudio` [@rstudio] IDE software, and employing the `knitr` [@knitr] and `Hmisc` [@Hmisc] packages for the `html` setup.

This dynamic document integrates **text**, **code** and **results**.

```{r setup0, results='hide', message=FALSE, eval=TRUE}
require(Hmisc)
#require(plotly)
#options(#grType='plotly',  # for certain graphics functions
#        width = 110) # to expand the limits of CONSOLE output
mu <- markupSpecs$html   # markupSpecs is in Hmisc

# The following hidden command (<code>r mu$widescreen()</code>), causes the html notebook to use an entire wide screen.
#mu$widescreen()
```
`r mu$widescreen()`

# Summary

**OBJECTIVE:**

* Principal: 
    - Standardize the OD~450nm~ values across ELISA plates by the estimation of the Antibody Units of each unknown sample.

* Secondary:
    - Implement a [reproducible workflow](https://www.ncbi.nlm.nih.gov/pubmed/26776185) for standardization of ELISA plates from a template matrix.

**SOLVED PROBLEMS:**


# Introduction

This is an R implementation of a pipeline for the standardization of ELISA plates directly from a template matrix.


# Dependencies

The required R packages for this analysis are:

+ XLConnect [@XLConnect]
+ drc [@Ritz2015]

```{r, results='hide', message=FALSE}
##essential
library(XLConnect) # to load EXCEL files
library(drc)       # Dose-Response modeling
##accesory
library("DiagrammeR") # method Flowchart
#library("rcompanion") # pseudo R-2
library("knitr")     # To display nice tables
##extra
library("ggplot2")
library("Rmisc")        #multiploting ggplots
#tidyverse
library(dplyr)
library(readr)
library(haven)
library(forcats)
library(readxl)
```

# read .Rds
```{r}
final <- readRDS("data/02-standard-tidy.rds")
finalDB <- readRDS("data/02-standard-untidy.rds")
```

- total amount of observations **`r length(final$ID)`**
- total amount of evaluated patients **`r length(levels(final$ID))`**
- giving **`r length(finalDB$ID)`** available samples in the `finalDB`.

# Covariates

The original non-standardized names of the **06** datasets with covariates are:

```{bash}
ls data-raw/ | grep -v "Template" | grep -v "zip" | grep -v "do"
```

In order to follow standardize names, the files we copied and renamed:

```{bash}
cp data-raw/UNAPdatabase20Sept16-pre.dta \
data/UNAP-1-DB-20sep2016.dta

cp data-raw/Zungarococha_database1_3Oct2016.csv \
data/UNAP-2-DB-03oct2016.csv

cp data-raw/UNAPdatabase20Sept16.dta \
data/UNAP-3-DB-02nov2016.dta

cp data-raw/RESULTADOS_LABORATORIO_PRIMER\ BARRIDO\ \(JUL-\ AGO\ 2015\).xlsx \
data/UNAP-4-DB-16ene2017.xlsx

cp data-raw/QC\ results\ Zungarococha.xlsx \
data/UNAP-5-QC-08feb2017.xlsx

cp data-raw/Base\ datos\ epidemiologicos\ 2015.xlsx \
data/UNAP-6-EPI-08feb2017.xlsx
```

New names include:

- order of appearance throughout the project
- relevand info: DB, QC or EPI
- date of registered last edition, or
- receipt date

```{bash}
ls -sh data/UNAP-*
```

# AIM

- check if `unap1` is equal to `unap2`
- `unap3` should be equal to `unap2` plus seropositivity agregate columns
- `unap3` was used in the online meeting with Nuno
- `unap4` have updated covariates and differs from `unap3`
- `unap5` have QC evaluations
- contrast:
    + `unap3` as prev-DB
    + `unap4` as post-DB
    + `unap5` as data-QC
- `unap6` will be edited in another .Rmd
- contrast:
    + `unap6` as prev-EPI



## UNAP-1-DB-20sep2016.dta

discoveries:

- `unap1` already have part of the seropositivity output in `unap3`
- variables absent in `unap2` are listed
- removed columns:
    + OD reads
    + sero-positive results (cutoff + categories)
    + age categories
    + pcrsnou 1/2 and pcrrubio 1/2

```{r}
unap1 <- haven::read_dta("data/UNAP-1-DB-20sep2016.dta") %>%
  haven::as_factor()
# previous removing
unap1.out <- unap1 %>% select((micro2:age3), -pcrrubio)
unap1 <- unap1 %>% select(-(micro2:age3), pcrrubio)
#unap1$id <- forcats::as_factor(unap1$id) # not required
str(unap1)
summary(unap1)
```

```{r}
colnames(unap1.out)
```


## UNAP-2-DB-03oct2016.csv

discoveries:

- `unap2` is a subset of `unap1`
- `unap2` do not used **pvmsp1n** variable

```{r}
unap2 <- read_csv("data/UNAP-2-DB-03oct2016.csv") %>%
  dplyr::mutate_each(funs(factor), 2, 4, 5, 9)
#str(unap2)
unap2.out <- unap2 %>% select(matches(".msp.")) # previous removing
unap2 <- unap2 %>% select(-matches(".msp.")) # OD reads removing
str(unap2)
summary(unap2)
```
```{r}
colnames(unap2.out)
```

```{r, fig.align='center', fig.height=3, fig.width=12, eval=FALSE}
par(mfrow=c(1,4))
hist(unap2[unap2$community==levels(unap2$community)[1],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(unap2$community)[1])
hist(unap2[unap2$community==levels(unap2$community)[2],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(unap2$community)[2])
hist(unap2[unap2$community==levels(unap2$community)[3],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(unap2$community)[3])
hist(unap2[unap2$community==levels(unap2$community)[4],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(unap2$community)[4])
```


## UNAP-3-DB-02nov2016.dta

discoveries:

- `unap3` have **05 more columns** than `unap1` about seropositivity

```{r}
unap3 <- haven::read_dta("data/UNAP-3-DB-02nov2016.dta") %>% 
  haven::as_factor()
#str(unap3)
# previous removing
unap3.out <- unap3 %>% select((micro2:ll_pvmsp1pos), -pcrrubio)
unap3 <- unap3 %>% select(-(micro2:ll_pvmsp1pos), pcrrubio)
#unap3$id <- forcats::as_factor(unap3$id) # not required
str(unap3)
summary(unap3)
```

```{r}
colnames(unap3.out)
summary(select(unap3.out, (seroposall:ll_pvmsp1pos)))
```


## UNAP-4-DB-16ene2017.xlsx

discoveries:

- `unap4` only differs in `age` and `sex`
- all the other covariates should be retrieved from `unap1`

```{r}
#read xl
unap4 <- readxl::read_excel("data/UNAP-4-DB-16ene2017.xlsx", 
                            sheet = 1, na = ".") %>%
  dplyr::select(id=1, sex=3, age=2, community=4, micro1=5, dens1=6, 
                pcrrubio_Pv=12, pcrrubio_Pf=13, pcrsnounou_Pv=14, pcrsnounou_Pf=15) %>%
  dplyr::mutate(pcrrubio= pcrrubio_Pf + pcrrubio_Pv,
                pcrsnounou= pcrsnounou_Pf + pcrsnounou_Pv) %>%
  dplyr::select(id:dens1,pcrrubio, pcrsnounou) %>%
  dplyr::mutate_each(funs(factor), 2,4,5,7,8)
str(unap4)
summary(unap4)

```

### unap4 covar

Covariate labeling is based on labels available in covariate DB sheet 2. If more clarity is required, we only need to change those cells.

```{r}
unap4.xl <- XLConnect::loadWorkbook("data/UNAP-4-DB-16ene2017.xlsx")
#
unap4.lb <- readWorksheet(unap4.xl, header = F,
                      sheet = 2, 
                      startRow = 8, endRow = 16,
                      startCol = 2, endCol = 6)
unap4.lb
```


```{r, eval=FALSE}
#covLabl
#as.character(covLabl[1,c(2:3)])#sex
#covLabl[3,]#community
#covLabl[5,]#specie

levels(unap4$sex) <- as.character(unap4.lb[1,c(2:3)])#sex
levels(unap4$community) <- as.character(unap4.lb[3,c(2:5)])#sex
levels(unap4$micro1) <- as.character(unap4.lb[5,c(4,2,3,5)])#specie ##LOOK change in ORDER
levels(unap4$micro2) <- as.character(unap4.lb[5,c(4,2,3,5)])#specie ##LOOK change in ORDER
levels(unap4$pcrrubio) <- as.character(unap4.lb[5,c(4,2,3)])#specie 
levels(unap4$pcrsnounou) <- as.character(unap4.lb[5,c(4,2,3)])#specie
```

```{r, fig.align='center', fig.height=3, fig.width=12, eval=FALSE}
par(mfrow=c(1,4))
hist(post[post$community==levels(post$community)[1],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(post$community)[1])
hist(post[post$community==levels(post$community)[2],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(post$community)[2])
hist(post[post$community==levels(post$community)[3],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(post$community)[3])
hist(post[post$community==levels(post$community)[4],]$age,
     ylim=c(0,150),
     xlab = "age",
     main=levels(post$community)[4])
```

```{r, eval=FALSE}
str(post)
summary(post)
```



## UNAP-5-QC-08feb2017.xlsx
```{r}
#read xl
unap5 <- readxl::read_excel("data/UNAP-5-QC-08feb2017.xlsx", na = "-")
#colnames(unap5)
unap5 <- unap5[,1:5]
#
unap5 <- unap5 %>% 
  dplyr::select(id=1, micro.unap=2, micro.namr=3, 
                pcr.unap=4, pcr.namr=5) %>%
  dplyr::mutate(micro.comp= micro.unap==micro.namr,
                pcr.comp= pcr.unap==pcr.namr) %>%
  dplyr::select(1:3,6,4:5,7) %>%
  dplyr::mutate_each(funs(factor), 2,3,5,6)
str(unap5)
summary(unap5)
```


## UNAP-6-EPI-08feb2017.xlsx

- New question, New .Rmd

```{r}
#check sheets
readxl::excel_sheets("data/UNAP-6-EPI-08feb2017.xlsx")
#read xl
epi <- readxl::read_excel("data/UNAP-6-EPI-08feb2017.xlsx", sheet = 1)
#filter NA
epi <- epi[1:sum(epi$id_integrante != "", na.rm = T), 1:sum(colnames(epi) != "")]
#963x109
colnames(epi)
#str(epi)
```

# MERGE COVARIATES

AIM:

- create `unap0`
- merge 
    + `unap1` age, sex
    + `unap4` age, sex
    + change factor label in sex
    + create 2 logic variables
    + `unap5` all
    + `unap1` community, micro1, dens1
    + optionally: micro2, dens2 + pcr.snounou

Any of this below could be usefull...

```{r}
#str(unap1)
#str(unap4)
unap4$sex <- fct_recode(unap4$sex, Female="1", Male="2")
#str(unap4)

unap0 <- 
  dplyr::full_join(
    unap1 %>%
      select(id, age, sex), 
    unap4 %>%
      select(id, age, sex), 
    by= "id", suffix= c("_1", "_4")) %>%
  mutate(sex0= sex_1==sex_4,
         age0= age_1==age_4)%>%
  select(1,3,5,6,2,4,7)%>%
  full_join(unap5, by= "id") %>%
  full_join(unap1 %>%
              select(id,community, micro1, dens1),
            by="id")
#
#unap0
str(unap0)
summary(unap0)

```

# PREVIOUS REPORT

## MERGE Ab.units and covariates

- AIM:
    + Merge **`r length(levels(finalDB$ID))` sample** Ab.units with its respective **`r length(post$id)` sample** covariates.
    + Finally, write a CSV of the outcome
    
```{r, eval=FALSE}
## NO RETRIEVEING
##    + First, retrieve the **`r length(finalEXCL)` excluded samples** [under which criteria?] due to unavailable covariate data.

chach <- finalDB
#finalDB <- chach

#dim(finalDB) # 966
## RETRIEVE excluded SAMPLES
for(i in 1:length(finalEXCL)) {
  finalDB <- finalDB[finalDB$ID!=finalEXCL[i],]
}
#dim(finalDB) #-9
```
    
```{r, eval=FALSE}
## NOW in false due to NO 'NA' RETRIEVING in 02-data-filtering.Rmd
##     + Second, introduce the **`r length(postEXCL)` automatically rejected samples** [check [NA description](#na)]

## ADD 03 automatically rejected samples as NaN (mean.OD below lower.limit)
#head(finalDB)
#tail(finalDB)

finalDB <- rbind(finalDB, 
                 data.frame(ID= postEXCL,
                            Ab.unit.Pfal= NaN,
                            Ab.unit.Pviv= NaN,
                            mean.OD.Pfal= NaN,
                            mean.OD.Pviv= NaN))
finalDB$ID <- factor(finalDB$ID)
#dim(finalDB) # +3
#tail(finalDB)
```

```{r}
### MERGING
### Third, 

#dim(post)
rownames(post) <- NULL
rownames(finalDB) <- NULL

finalDBcov <- merge(post, finalDB, by.x = "id", by.y = "ID", all = T)
```

```{r, eval=FALSE}
## NOW in FALSE due to NO 'NA' RETRIEVING in 02-data-filtering.Rmd

finalDBcov <- data.frame()
for(i in 1:length(post$id)) {
  finalDBcov <- rbind(finalDBcov,
                      cbind(post[post$id==post$id[i],],
                            finalDB[finalDB$ID==post$id[i],]))
}
#finalDBcov$id == finalDBcov$ID
#dim(finalDBcov)
```


The `finalDBcov` output is write as `Standardized_ELISA_ALL_COVARIATES.csv`:
```{r}
str(finalDBcov)
summary(finalDBcov)
```

The `finalDBcov` data.frame is ready to re-run the seropositivity analysis.



## MERGE all

```{r}
colnames(unap2) <- c(colnames(unap2)[1],paste0(colnames(unap2)[-1],".1"))
colnames(post) <- c(colnames(post)[1],paste0(colnames(post)[-1],".2"))
```


```{r}
final_allcov <- merge(merge(unap2[,-c(7,8)], post, 
                            by= "id", 
                            all = T),
                      final[,-c(7,8)], 
                      by.x = "id", by.y = "ID", 
                      all = T)
str(final_allcov)
summary(final_allcov)
```



## COMPARISON of covariates

## EVALUATE 01 patient 02 IDs

- AIM:
    + Contrast the data of the samples mentioned in the 2nd sheet of `UNAP-4-DB-16ene2017.xlsx`

```{r}
deldobl <- readWorksheet(pos, 
                      sheet = 2, 
                      startRow = 20, endRow = 27,
                      startCol = 2, endCol = 3)
deldobl

#str(deldobl)
```

Strings were split into individual characters in the following way:
```{r}
strsplit(deldobl[5,], split = " ")[[1]]
```

Check equality between pair of samples:
```{r}
deldoblMIX <- data.frame()
for(i in 1:dim(deldobl)[1]) {
  deldoblMIX <- rbind(deldoblMIX,
                      finalDBcov[finalDBcov$id==
                                   strsplit(deldobl[i,], 
                                            split = " ")[[1]][1],],
                      finalDBcov[finalDBcov$id==
                                   strsplit(deldobl[i,], 
                                            split = " ")[[1]][3],])
}

format(deldoblMIX[,-c(7,8,10)], scientific=FALSE, digits=2)#

#finalDBcov[finalDBcov$id==strsplit(deldobl[4,], split = " ")[[1]][1],]
```

Some equalities do not seem to be from the same patient. This step needs more support prior to any sample deletion.




# EXPORT

- `finalDBcov` output is write as `data/03-standard-untidy-cov.csv`.
- `final_allcov` output is write as `data/03-standard-tidy-cov.csv`:

```{r}

# WRITE untidy CSV
write.csv(format(finalDBcov, scientific=FALSE, digits=2), "data/03-standard-untidy-cov.csv")# WITHOUT LABELING!!

# WRITE untidy CSV
write.csv(format(final_allcov, scientific=FALSE, digits=2), "data/03-standard-tidy-cov.csv")# WITHOUT LABELING!!
```

# save .Rds
```{r}
saveRDS(finalDBcov, "data/03-standard-untidy-cov.rds")
saveRDS(final_allcov, "data/03-standard-tidy-cov.rds")
```

# References